---
kind: pipeline
type: docker
name: build-s390x

platform:
  os: linux
  arch: amd64

node:
  arch: s390x

steps:
  - name: build
    image: rancher/hardened-build-base:v1.16.9b7
    failure: ignore
    commands:
      - make all
      - make build-kustomize-api generate-kustomize-api
      - pwd
      - where is kustomize
    volumes:
      - name: docker
        path: /var/run/docker.sock

  - name: publish-dist-artifacts
    image: rancher/drone-images:github-release-s390x
    failure: ignore
    settings:
      api_key:
        from_secret: github_token
      checksum:
        - sha256
      checksum_file: CHECKSUMsum-s390x.txt
      checksum_flatten: true
      files:
        - /go/bin/helmV3/helm-v3.6.3-linux-s390x.tar.gz
      prerelease: true
    # when:
    #   instance:
    #     - drone-publish.rancher.io
    #   ref:
    #     - refs/head/master
    #     - refs/tags/*

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock
